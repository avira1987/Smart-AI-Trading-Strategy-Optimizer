# راهنمای مکانیزم ردیابی منابع داده و تحلیل

## خلاصه

این سیستم به کاربران امکان می‌دهد تا از منابع داده و تحلیل استفاده شده در پردازش استراتژی‌ها و بک‌تست‌ها مطلع شوند.

## منابع داده (Data Sources)

اطلاعات مربوط به منابع داده در مدل `Result` ذخیره می‌شود و شامل موارد زیر است:

- **provider**: نام ارائه‌دهنده داده استفاده شده (financialmodelingprep, twelvedata, alphavantage, oanda, metalsapi, mt5)
- **symbol**: نماد معاملاتی استفاده شده
- **start_date**: تاریخ شروع داده‌ها
- **end_date**: تاریخ پایان داده‌ها
- **data_points**: تعداد نقاط داده دریافت شده
- **available_providers**: لیست ارائه‌دهندگان در دسترس
- **timeframe_days**: تعداد روزهای بازه زمانی
- **data_range**: بازه زمانی واقعی داده‌ها (first_date, last_date)

### نحوه دسترسی در API

در endpoint مربوط به `Job` یا `Result`، فیلد `data_sources` و `data_sources_display` در دسترس است:

```python
{
  "data_sources": {
    "provider": "financialmodelingprep",
    "symbol": "EUR/USD",
    "start_date": "2024-01-01",
    "end_date": "2024-12-31",
    "data_points": 365,
    ...
  },
  "data_sources_display": {
    "provider": "financialmodelingprep",
    "provider_display": "Financial Modeling Prep",
    "provider_name_fa": "Financial Modeling Prep",
    ...
  }
}
```

## منابع تحلیل (Analysis Sources)

اطلاعات مربوط به منابع تحلیل در مدل `TradingStrategy` ذخیره می‌شود و شامل موارد زیر است:

### اطلاعات تحلیل:
- **nlp_parser**: استفاده از NLP Parser برای استخراج اطلاعات
- **analysis_method**: روش تحلیل استفاده شده (gemini_ai, basic_analysis, failed)
- **ai_model**: مدل هوش مصنوعی استفاده شده (gemini, None)
- **text_length**: طول متن استخراج شده
- **gemini_error**: پیام خطا در صورت شکست Gemini (اختیاری)
- **analysis_error**: پیام خطا در صورت شکست تحلیل (اختیاری)

### اطلاعات منابع داده در تحلیل:
- **data_sources**: اطلاعات مربوط به منابع داده که برای تحلیل استفاده شده است:
  - **strategy_symbol**: نماد معاملاتی استخراج شده از استراتژی
  - **strategy_timeframe**: تایم‌فریم استخراج شده از استراتژی
  - **indicators_mentioned**: لیست اندیکاتورهای ذکر شده در استراتژی
  - **available_providers**: لیست ارائه‌دهندگان داده در دسترس در زمان تحلیل
  - **providers_count**: تعداد ارائه‌دهندگان در دسترس
  - **source_file_length**: طول فایل منبع استراتژی

### نحوه دسترسی در API

در endpoint مربوط به `TradingStrategy`، فیلد `analysis_sources` و `analysis_sources_display` در دسترس است:

```python
{
  "analysis_sources": {
    "nlp_parser": "nlp_parser",
    "analysis_method": "gemini_ai",
    "ai_model": "gemini",
    "text_length": 5000,
    "data_sources": {
      "strategy_symbol": "EUR/USD",
      "strategy_timeframe": "M15",
      "indicators_mentioned": ["RSI", "MACD"],
      "available_providers": ["financialmodelingprep", "twelvedata"],
      "providers_count": 2,
      "source_file_length": 5000
    }
  },
  "analysis_sources_display": {
    "nlp_parser": "nlp_parser",
    "nlp_parser_display": "Parser NLP",
    "analysis_method": "gemini_ai",
    "analysis_method_display": "هوش مصنوعی Gemini",
    "ai_model": "gemini",
    "ai_model_display": "Google Gemini AI",
    "data_sources_display": {
      "strategy_symbol": "EUR/USD",
      "strategy_timeframe": "M15",
      "indicators_mentioned": ["RSI", "MACD"],
      "indicators_count": 2,
      "has_symbol": true,
      "has_timeframe": true,
      "available_providers": ["financialmodelingprep", "twelvedata"],
      "available_providers_display": ["Financial Modeling Prep", "TwelveData"],
      "available_providers_names_fa": ["Financial Modeling Prep", "TwelveData"],
      "providers_count": 2,
      "source_file_length": 5000
    }
  }
}
```

## استفاده در Frontend

برای نمایش این اطلاعات در frontend، می‌توانید از فیلدهای `*_display` استفاده کنید که شامل نام‌های فارسی و قابل فهم‌تر هستند.

### مثال نمایش منابع داده:

```typescript
const DataSourcesDisplay = ({ result }) => {
  const sources = result.data_sources_display;
  
  return (
    <div>
      <h3>منابع داده استفاده شده</h3>
      <p>ارائه‌دهنده: {sources.provider_display}</p>
      <p>نماد: {sources.symbol}</p>
      <p>بازه زمانی: {sources.start_date} تا {sources.end_date}</p>
      <p>تعداد داده: {sources.data_points}</p>
    </div>
  );
};
```

### مثال نمایش منابع تحلیل:

```typescript
const AnalysisSourcesDisplay = ({ strategy }) => {
  const sources = strategy.analysis_sources_display;
  const dataSources = sources.data_sources_display || {};
  
  return (
    <div>
      <h3>منابع تحلیل استفاده شده</h3>
      <p>روش تحلیل: {sources.analysis_method_display}</p>
      <p>مدل هوش مصنوعی: {sources.ai_model_display}</p>
      <p>Parser NLP: {sources.nlp_parser_display}</p>
      
      <h4>منابع داده در تحلیل</h4>
      {dataSources.strategy_symbol && (
        <p>نماد استراتژی: {dataSources.strategy_symbol}</p>
      )}
      {dataSources.strategy_timeframe && (
        <p>تایم‌فریم: {dataSources.strategy_timeframe}</p>
      )}
      {dataSources.indicators_mentioned && (
        <p>اندیکاتورها: {dataSources.indicators_mentioned.join(', ')}</p>
      )}
      {dataSources.available_providers_display && (
        <div>
          <p>ارائه‌دهندگان داده در دسترس:</p>
          <ul>
            {dataSources.available_providers_display.map((provider, idx) => (
              <li key={idx}>{provider}</li>
            ))}
          </ul>
        </div>
      )}
    </div>
  );
};
```

## نکات مهم

1. فیلدهای `data_sources` و `analysis_sources` به صورت خودکار پر می‌شوند و نیازی به تنظیم دستی ندارند.
2. در صورت عدم وجود داده، این فیلدها یک دیکشنری خالی برمی‌گردانند.
3. نام‌های نمایشی (`*_display`) برای استفاده در رابط کاربری بهینه شده‌اند.
4. **منابع داده در تحلیل**: اطلاعات مربوط به منابع داده در بخش `data_sources` از `analysis_sources` ذخیره می‌شود. این شامل نماد، تایم‌فریم و ارائه‌دهندگان در دسترس در زمان تحلیل است.
5. **شفافیت بیشتر**: با ذخیره منابع داده در تحلیل، کاربر می‌تواند دقیقاً ببیند که چه اطلاعاتی برای تحلیل استراتژی او استفاده شده است.

