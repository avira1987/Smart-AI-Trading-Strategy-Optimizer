# تحلیل روش‌های استارت و استاپ

## خلاصه مشکل

در حال حاضر:
- ✅ FastAPI (احتمالاً منظور Django Backend) در حال اجرا است و از اینترنت با IP ولید قابل دسترسی است
- ✅ وب‌سایت با فایل `.\start_all_port80.ps1` از اینترنت در دسترس است
- ❌ اما هنگام ورود به وب‌سایت، پیام خطا نمایش داده می‌شود: **"خطا: Backend در حال اجرا نیست. لطفا مطمئن شوید که Backend روی پورت 8000 در حال اجرا است."**

## علت مشکل

فایل `start_all_port80.ps1` **فقط Frontend را روی پورت 80 راه‌اندازی می‌کند** و Backend را راه‌اندازی نمی‌کند!

### بررسی فایل `start_all_port80.ps1`:
- ✅ IIS را متوقف می‌کند
- ✅ Node processes را متوقف می‌کند
- ✅ پورت 80 را بررسی می‌کند
- ✅ Frontend را build می‌کند (اگر نیاز باشد)
- ✅ Frontend را روی پورت 80 راه‌اندازی می‌کند
- ❌ **Backend را راه‌اندازی نمی‌کند!**

### بررسی Frontend:
- Frontend در فایل `frontend/src/pages/Login.tsx` هنگام بارگذاری CAPTCHA، به Backend متصل می‌شود
- اگر Backend در دسترس نباشد، خطای "Backend در حال اجرا نیست" نمایش داده می‌شود
- Frontend انتظار دارد Backend روی `http://127.0.0.1:8000` در حال اجرا باشد

## تحلیل فایل‌های استارت موجود

### 1. `start.ps1` (اصلی)
- ✅ Redis را بررسی و راه‌اندازی می‌کند
- ✅ پردازه‌های قبلی را متوقف می‌کند
- ✅ Database migrations را اجرا می‌کند
- ✅ Backend را روی `0.0.0.0:8000` راه‌اندازی می‌کند
- ✅ Frontend را روی پورت 3000 (یا پورت تنظیم شده) راه‌اندازی می‌کند
- ✅ Celery Worker و Beat را راه‌اندازی می‌کند
- ❌ Frontend را روی پورت 80 راه‌اندازی نمی‌کند

### 2. `start_all_port80.ps1` (فعال)
- ✅ Frontend را روی پورت 80 راه‌اندازی می‌کند
- ✅ IIS را متوقف می‌کند
- ❌ **Backend را راه‌اندازی نمی‌کند!**
- ❌ Redis را بررسی نمی‌کند
- ❌ Database migrations را اجرا نمی‌کند

### 3. `start_production_ip_only.ps1`
- ✅ Backend را با Gunicorn راه‌اندازی می‌کند
- ✅ Frontend را روی پورت 80 راه‌اندازی می‌کند
- ✅ Redis را بررسی می‌کند
- ✅ Frontend را build می‌کند
- ⚠️ از Gunicorn استفاده می‌کند (برای production)

### 4. `scripts/START_ALL.ps1`
- ✅ تمام سرویس‌ها را راه‌اندازی می‌کند
- ✅ Frontend را روی پورت 3000 راه‌اندازی می‌کند (نه 80)
- ❌ Frontend را روی پورت 80 راه‌اندازی نمی‌کند

## تحلیل فایل‌های استاپ موجود

### 1. `stop.ps1` (اصلی)
- ✅ Node processes را متوقف می‌کند
- ✅ Django processes را متوقف می‌کند
- ✅ Celery processes را متوقف می‌کند
- ✅ Redis را بررسی می‌کند (اما متوقف نمی‌کند)

### 2. `scripts/STOP_ALL.ps1`
- ✅ Node processes را متوقف می‌کند
- ✅ Python processes را متوقف می‌کند
- ✅ Celery processes را متوقف می‌کند
- ✅ Redis را بررسی می‌کند (اما متوقف نمی‌کند)

## راه‌حل: فایل‌های جدید `start.ps1` و `stop.ps1`

### فایل جدید `start.ps1`

این فایل ترکیبی از بهترین ویژگی‌های فایل‌های موجود است:

#### ویژگی‌ها:
1. ✅ **IIS را متوقف می‌کند** (برای آزاد کردن پورت 80)
2. ✅ **پردازه‌های قبلی را متوقف می‌کند** (Node, Django, Celery)
3. ✅ **پورت 80 را بررسی می‌کند** و در صورت نیاز آزاد می‌کند
4. ✅ **Redis را بررسی و راه‌اندازی می‌کند** (با Docker)
5. ✅ **Database migrations را اجرا می‌کند**
6. ✅ **Backend را روی `0.0.0.0:8000` راه‌اندازی می‌کند** (قابل دسترسی از اینترنت)
7. ✅ **Frontend را build می‌کند** (اگر نیاز باشد)
8. ✅ **Frontend را روی پورت 80 راه‌اندازی می‌کند** (با `npm run preview`)
9. ✅ **وضعیت Backend را بررسی می‌کند** (برای اطمینان از راه‌اندازی)

#### تنظیمات:
- Backend: `0.0.0.0:8000` (قابل دسترسی از اینترنت)
- Frontend: `0.0.0.0:80` (قابل دسترسی از اینترنت)
- Backend URL برای Frontend: `http://127.0.0.1:8000`
- Redis: Port 6379 (با Docker)

### فایل جدید `stop.ps1`

این فایل تمام سرویس‌ها را به درستی متوقف می‌کند:

#### ویژگی‌ها:
1. ✅ **Node processes را متوقف می‌کند** (Frontend)
2. ✅ **Django processes را متوقف می‌کند** (Backend)
3. ✅ **Celery processes را متوقف می‌کند**
4. ✅ **وضعیت Redis را بررسی می‌کند** (اما متوقف نمی‌کند - چون توسط Docker مدیریت می‌شود)

## نحوه استفاده

### راه‌اندازی:
```powershell
.\start.ps1
```

این دستور:
1. تمام سرویس‌های قبلی را متوقف می‌کند
2. IIS را متوقف می‌کند
3. Redis را راه‌اندازی می‌کند (اگر نیاز باشد)
4. Backend را روی پورت 8000 راه‌اندازی می‌کند
5. Frontend را روی پورت 80 راه‌اندازی می‌کند

### توقف:
```powershell
.\stop.ps1
```

این دستور تمام سرویس‌ها را متوقف می‌کند (به جز Redis که توسط Docker مدیریت می‌شود).

## آدرس‌های دسترسی

بعد از اجرای `start.ps1`:

### Frontend:
- Local: `http://localhost`
- Internet: `http://191.101.113.163`
- Domain: `http://myaibaz.ir` (via Cloudflare)

### Backend:
- Local: `http://localhost:8000`
- Internet: `http://191.101.113.163:8000`
- Admin: `http://191.101.113.163:8000/admin/`

## نکات مهم

1. **Backend باید روی `0.0.0.0:8000` اجرا شود** تا از اینترنت قابل دسترسی باشد
2. **Frontend از طریق `/api` به Backend متصل می‌شود** (با استفاده از Vite proxy در development یا Nginx در production)
3. **Redis باید همیشه در حال اجرا باشد** (برای session management و caching)
4. **برای دسترسی از اینترنت، فایروال باید پورت‌های 80 و 8000 را باز کند**

## مقایسه با فایل‌های قبلی

| ویژگی | `start_all_port80.ps1` | `start.ps1` (جدید) |
|-------|------------------------|-------------------|
| متوقف کردن IIS | ✅ | ✅ |
| متوقف کردن پردازه‌های قبلی | ✅ | ✅ |
| بررسی پورت 80 | ✅ | ✅ |
| راه‌اندازی Redis | ❌ | ✅ |
| اجرای Migrations | ❌ | ✅ |
| راه‌اندازی Backend | ❌ | ✅ |
| Build Frontend | ✅ | ✅ |
| راه‌اندازی Frontend روی پورت 80 | ✅ | ✅ |
| بررسی وضعیت Backend | ❌ | ✅ |

## نتیجه‌گیری

فایل‌های جدید `start.ps1` و `stop.ps1` تمام مشکلات را حل می‌کنند:
- ✅ Backend را راه‌اندازی می‌کنند
- ✅ Frontend را روی پورت 80 راه‌اندازی می‌کنند
- ✅ تمام وابستگی‌ها (Redis, Migrations) را مدیریت می‌کنند
- ✅ از اینترنت قابل دسترسی هستند

**استفاده از این فایل‌ها به جای `start_all_port80.ps1` توصیه می‌شود.**

